name: Android Test Pipeline

on:
  push:
    branches:
      - '**'  # Trigger for all branches
  pull_request:
    branches:
      - '**'  # Trigger for all pull requests
  schedule:
    - cron: '0 2 * * *'  # Nightly runs at 2 AM UTC for Release Candidate Tests

jobs:
  unit_and_component_tests:
    name: Unit and Component Tests
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup JDK
      uses: actions/setup-java@v3
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v2
      with:
        api-level: 33
        build-tools: 33.0.2

    - name: Run Unit Tests
      run: ./gradlew testDebugUnitTest

    - name: Run Component Tests
      run: ./gradlew connectedAndroidTest

  feature_tests:
    name: Feature Tests
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup JDK
      uses: actions/setup-java@v3
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v2
      with:
        api-level: 33
        build-tools: 33.0.2

    - name: Install Emulator System Image
      run: sdkmanager "system-images;android-33;google_apis;x86_64"

    - name: Create Emulator
      run: avdmanager create avd -n test -k "system-images;android-33;google_apis;x86_64" --device "pixel_3a"

    - name: Start Emulator
      run: |
        $ANDROID_SDK_ROOT/emulator/emulator -avd test -no-audio -no-window -gpu swiftshader_indirect &
      env:
        ANDROID_SDK_ROOT: /usr/local/android-sdk

    - name: Wait for Emulator
      run: |
        adb wait-for-device
        adb shell input keyevent 82  # Unlock screen

    - name: Run Feature Tests
      run: ./gradlew connectedAndroidTest

  application_tests:
    name: Application Tests
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup JDK
      uses: actions/setup-java@v3
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v2
      with:
        api-level: 33
        build-tools: 33.0.2

    - name: Install Emulator System Image
      run: sdkmanager "system-images;android-33;google_apis;x86_64"

    - name: Create Emulator
      run: avdmanager create avd -n test -k "system-images;android-33;google_apis;x86_64" --device "pixel_3a"

    - name: Start Emulator
      run: |
        $ANDROID_SDK_ROOT/emulator/emulator -avd test -no-audio -no-window -gpu swiftshader_indirect &
      env:
        ANDROID_SDK_ROOT: /usr/local/android-sdk

    - name: Wait for Emulator
      run: |
        adb wait-for-device
        adb shell input keyevent 82  # Unlock screen

    - name: Run Application Tests
      run: ./gradlew connectedAndroidTest

  release_candidate_tests:
    name: Release Candidate Tests
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup JDK
      uses: actions/setup-java@v3
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v2
      with:
        api-level: 33
        build-tools: 33.0.2

    - name: Install Emulator System Image
      run: sdkmanager "system-images;android-33;google_apis;x86_64"

    - name: Create Emulator
      run: avdmanager create avd -n test -k "system-images;android-33;google_apis;x86_64" --device "pixel_3a"

    - name: Start Emulator
      run: |
        $ANDROID_SDK_ROOT/emulator/emulator -avd test -no-audio -no-window -gpu swiftshader_indirect &
      env:
        ANDROID_SDK_ROOT: /usr/local/android-sdk

    - name: Wait for Emulator
      run: |
        adb wait-for-device
        adb shell input keyevent 82  # Unlock screen

    - name: Run Release Candidate Tests
      run: ./gradlew connectedAndroidTest
